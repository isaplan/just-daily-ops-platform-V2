---
alwaysApply: true
---

# üõë RULE #0: UNDERSTAND ‚Üí CLARIFY ‚Üí CONFIRM ‚Üí BUILD

**Before ANY action:**
1. Understand EXACTLY what user wants (read carefully, don't skim)
2. **SHOW FULL PLAN FIRST** - List ALL files you'll touch (create/modify/delete)
3. Identify protected files (`"touch_again": false` in `function-registry.json`)
4. Ask for permission if touching protected files (see C1 workflow below)
5. Get explicit approval ("Go ahead" / "Confirm")
6. THEN execute (no more, no less)

**IF IN DOUBT ‚Üí ASK. IF ASSUMING ‚Üí ASK. IF UNCLEAR ‚Üí ASK.**

---

## üîç MANDATORY VERIFICATION WITH EVIDENCE (CRITICAL - NO EXCEPTIONS)

### **üö´ ABSOLUTE PROHIBITION: NEVER ASSUME SUCCESS**

**You CANNOT claim something works without providing evidence.**

### **Verification Requirements:**

#### **1. Database Operations (CREATE/UPDATE/DELETE):**
**MUST verify with actual database query:**

```typescript
// ‚ùå FORBIDDEN - Never do this:
"Data has been saved successfully"

// ‚úÖ REQUIRED - Always do this:
// Step 1: Execute the operation
await db.collection('collection').insertOne(data);

// Step 2: VERIFY with actual query
const verification = await db.collection('collection').findOne({ _id: result.insertedId });
if (!verification) {
  throw new Error('Verification failed: Record not found after insert');
}

// Step 3: Show evidence to user
console.log('‚úÖ VERIFIED: Record exists in database');
console.log('Evidence:', JSON.stringify(verification, null, 2));
```

**For data sync operations:**
- **MUST** call check-data endpoint: `/api/[provider]/v2/check-data?month=X&year=Y`
- **MUST** show actual record count: `totalRecords: X`
- **MUST** show sample records or date range evidence
- **NEVER** claim "data is synced" without showing query results

#### **2. API Endpoint Creation:**
**MUST verify endpoint actually responds:**

```bash
# ‚ùå FORBIDDEN:
"API endpoint created successfully"

# ‚úÖ REQUIRED:
# Step 1: Create endpoint
# Step 2: Test with actual HTTP request
curl http://localhost:3000/api/endpoint

# Step 3: Show response evidence
Response: { "success": true, "data": [...] }
Status: 200 OK
```

#### **3. User Questions Requiring Verification:**
**When user asks "did it work?" or "do we have data?":**

```typescript
// ‚ùå FORBIDDEN - Never assume:
"Yes, the data is there"

// ‚úÖ REQUIRED - Always verify:
// Step 1: Run actual check
const checkResponse = await fetch('/api/bork/v2/check-data?month=11&year=2025');
const checkData = await checkResponse.json();

// Step 2: Show evidence
if (checkData.success && checkData.data.totalRecords > 0) {
  console.log(`‚úÖ VERIFIED: ${checkData.data.totalRecords} records found`);
  console.log('Evidence:', JSON.stringify(checkData.data, null, 2));
} else {
  console.log('‚ùå VERIFIED: No records found');
  console.log('Evidence:', JSON.stringify(checkData, null, 2));
}
```

#### **4. Code Changes:**
**MUST verify code actually works:**

```bash
# ‚ùå FORBIDDEN:
"Fixed the date parsing issue"

# ‚úÖ REQUIRED:
# Step 1: Make code change
# Step 2: Test with actual input
# Step 3: Show test results
Test Input: "20251101"
Test Output: Date object { year: 2025, month: 10, day: 1 }
‚úÖ VERIFIED: Date parsing works correctly
```

### **Evidence Format Requirements:**

**Every verification MUST include:**
1. **Query/Command executed** (exact command or code)
2. **Response/Result received** (actual output, not description)
3. **Evidence snippet** (JSON, log output, or data sample)
4. **Verification status** (‚úÖ VERIFIED or ‚ùå VERIFICATION FAILED)

**Example Evidence Report:**
```
üîç VERIFICATION REPORT:

Operation: Bork API sync for November 2025
Location: L'Amour Toujours

Verification Query:
GET /api/bork/v2/check-data?month=11&year=2025

Evidence:
{
  "success": true,
  "data": {
    "totalRecords": 30,
    "byLocation": [
      {
        "locationName": "L'Amour Toujours",
        "count": 30,
        "minDate": "2025-11-01T00:00:00.000Z",
        "maxDate": "2025-11-30T00:00:00.000Z"
      }
    ]
  }
}

Status: ‚úÖ VERIFIED - 30 records found in database
```

### **When Verification Fails:**

**If verification shows failure:**
1. **STOP immediately**
2. **Report failure with evidence**
3. **Show what was expected vs. what was found**
4. **DO NOT** claim success or move on
5. **Ask user** how to proceed

**Example Failure Report:**
```
‚ùå VERIFICATION FAILED:

Operation: Bork API sync for November 2025
Expected: Records in bork_raw_data collection
Actual: 0 records found

Evidence:
{
  "success": true,
  "data": {
    "totalRecords": 0
  }
}

Action Required: Investigate why sync did not save data
```

### **Special Cases Requiring Verification:**

1. **"Did we get data?"** ‚Üí MUST query database and show record count
2. **"Is it working?"** ‚Üí MUST test endpoint/function and show output
3. **"Did the sync complete?"** ‚Üí MUST check database and show records
4. **"Is the fix working?"** ‚Üí MUST test with actual input/output
5. **Any success claim** ‚Üí MUST provide evidence

### **Verification Tools Available:**

- **Database checks:** `/api/[provider]/v2/check-data`
- **Admin checks:** `/api/admin/check-data`
- **Direct MongoDB queries:** Use `getDatabase()` and show results
- **API testing:** Use `fetch()` or `curl` and show response
- **Code testing:** Run actual test cases and show output

### **üö´ NEVER:**

- ‚ùå Claim success without evidence
- ‚ùå Say "it should work" or "it probably worked"
- ‚ùå Assume data is there without checking
- ‚ùå Skip verification because "it's obvious"
- ‚ùå Provide verification that doesn't show actual data/results

### **‚úÖ ALWAYS:**

- ‚úÖ Verify with actual queries/tests
- ‚úÖ Show evidence (JSON, logs, data samples)
- ‚úÖ Report verification status explicitly
- ‚úÖ Include record counts, timestamps, or data samples
- ‚úÖ Acknowledge if verification fails

---

## üîí BRANCH-AWARE REGISTRY PROTECTION

### Before Starting Work:

**1. Check Current Branch:**
```bash
git branch --show-current
```

**2. Analyze & Show Full Plan:**
```
"Here's what I need to do:

Files to CREATE:
- [list new files]

Files to MODIFY:
- [list files to modify]
  ‚ö†Ô∏è  [mark protected files with warning]
  
Files to DELETE:
- [list files to delete]

Protected files requiring permission: [count]"
```

---

### Protection Rules by Branch:

#### üî¥ ON MAIN BRANCH:
**HARD BLOCK - ZERO EXCEPTIONS**

Files with `"touch_again": false` in `function-registry.json` = **NEVER TOUCH**

**Exception:** If you followed C1 questioning and user said "Go ahead/Confirm" ‚Üí Allowed

**If you need to modify protected file on main:**
1. STOP immediately
2. Tell user: "‚ö†Ô∏è  This file is protected on main. Please create a feature branch for this change."
3. Do NOT proceed

---

#### üü° ON FEATURE BRANCH:
**ASK PERMISSION BEFORE TOUCHING (C1 WORKFLOW)**

**For EACH protected file, show this exact permission request:**

```
‚ö†Ô∏è  PERMISSION REQUIRED

File: [full/path/to/file.ts]
Status: Marked as "completed" on main branch
Registry: "touch_again": false
Current branch: [branch-name]

What I want to do:
- [Specific change 1]
- [Specific change 2]
- ~[X] lines of code
- Type: [Additive/Modification/Deletion]

Reason: [Why this change is needed for your feature]

Do you want me to:
A) Go ahead / Confirm - Proceed with changes
B) Find alternative (don't touch this file)
C) Show alternatives first, then decide

Your choice?
```

**Then:**
1. WAIT for user response
2. If "Go ahead" or "Confirm" ‚Üí Log permission (see below) ‚Üí Proceed
3. If "Find alternative" ‚Üí Don't touch file, find different approach
4. If unclear answer ‚Üí ASK AGAIN clearly

---

## üìù PERMISSION LOGGING (MANDATORY)

**When user says "Go ahead/Confirm", YOU MUST log permission in BOTH places:**

### A) Git Commit Message:
Include this in your commit:
```
Modified protected file(s):
- [file path]
  Permission: Granted by user
  Session: [ISO timestamp]
  Reason: [reason]
  Changes: +[X] lines / -[Y] lines
```

### B) Permission Log File:
Update `.ai-compliance-permissions.json`:
```json
{
  "permissions": [
    {
      "timestamp": "[ISO 8601 timestamp]",
      "branch": "[branch-name]",
      "file": "[full/path/to/file]",
      "reason": "[detailed reason]",
      "approved_by": "user",
      "session_id": "[unique-session-id]",
      "changes": "+X lines / -Y lines",
      "type": "additive|modification|deletion"
    }
  ]
}
```

**If file doesn't exist, create it. If exists, append to the array.**

---

## üö´ ABSOLUTE PROHIBITIONS (All Branches)

### Size Limits:
- **Max 120 lines changed per file** per task
- **Max 20 lines deleted per file**
- **No full file replacements** (>80% of lines changed)

If >120 lines needed ‚Üí STOP ‚Üí Break into smaller tasks ‚Üí Ask user to approve each

### No Bypass Flags:
**NEVER use:**
- `git commit --no-verify` (bypasses pre-commit hooks)
- `git push --force` (bypasses branch protection)
- `git push --no-verify` (bypasses compliance checks)
- Modify `.git/hooks/` or compliance scripts

**If compliance check fails:**
1. STOP immediately
2. Report all violations to user
3. Wait for explicit user decision
4. NEVER assume permission to bypass

---

## üîÑ LOOP PREVENTION (HARDCODED)

After 2 failed attempts at same fix, on 3rd attempt:
1. **STOP** and reconsider the solution
2. **ANALYZE** what didn't work in previous attempts
3. **IDENTIFY** the root cause of failure
4. **PROPOSE** a completely different approach
5. **ASK** user for permission to try new approach
6. **MOVE ON** if no clear solution after 3 attempts

---

## üîç REGISTRY UPDATE (AUTOMATED EVERY 3 HOURS)

**Fully Automated via GitHub Actions:**

Registry updates run automatically on GitHub Actions:
- ‚è∞ Every 3 hours (0am, 3am, 6am, 9am, 12pm, 3pm, 6pm, 9pm)
- üõë Skips 3-10am window (early morning)
- üîÑ Auto-commits changes if any
- üö´ No AI involved
- üí∞ Zero token cost to you

**What happens automatically:**
- Scans all 487 files
- Updates protection status
- Marks completed files as `"touch_again": false`
- Commits to main if changes detected

**Manual Override (if needed):**
```bash
npm run registry:update
```

**Status:** ‚úÖ GitHub Actions configured - fully automated

---

## üîç MANDATORY VERIFICATION AFTER DATA OPERATIONS

**AFTER ANY data sync, insert, update, or delete operation:**

1. **Run verification query:**
   - For sync operations: Call `/api/[provider]/v2/check-data` with appropriate parameters
   - For inserts: Query the inserted record by ID
   - For updates: Query the updated record and show changed fields
   - For deletes: Verify record no longer exists

2. **Show evidence to user:**
   - Record count (if applicable)
   - Sample records or data
   - Date ranges (if applicable)
   - Error messages (if verification fails)

3. **Report verification status:**
   - ‚úÖ VERIFIED: [evidence summary]
   - ‚ùå VERIFICATION FAILED: [what was expected vs. what was found]

4. **If verification fails:**
   - STOP immediately
   - Report failure with evidence
   - DO NOT claim success
   - Ask user how to proceed

**Example Verification After Sync:**
```bash
# After syncing Bork data for November 2025
curl http://localhost:3000/api/bork/v2/check-data?month=11&year=2025

# Show response:
{
  "success": true,
  "data": {
    "totalRecords": 30,
    "byLocation": [...]
  }
}

# Report:
‚úÖ VERIFIED: 30 records found in bork_raw_data for November 2025
```

**You CANNOT skip verification. Every data operation MUST be verified with evidence.**

---

**Status**: üõ°Ô∏è UNBREAKABLE RULES ACTIVE | Mode: BRANCH-AWARE | Protected: 284+ files | Max Lines: 120 | Verification: MANDATORY WITH EVIDENCE

---
alwaysApply: true
---

# üõ°Ô∏è CURSOR AI COMPLIANCE RULES - ALWAYS ENFORCED

## üõë **RULE #0: UNDERSTAND ‚Üí CLARIFY ‚Üí CONFIRM ‚Üí BUILD**
### **THE MOST IMPORTANT RULE (OVERRIDES ALL OTHERS)**

**Before ANY action:**
1. **Understand EXACTLY what user wants** - Read carefully, don't skim
2. **Identify assumptions** - What am I assuming that wasn't explicitly stated?
3. **Ask clarifying questions** - If ANYTHING is unclear or assumed
4. **Confirm the plan** - Show what you'll do, wait for approval
5. **Align on scope** - Make sure we're on the same page
6. **ONLY THEN: Execute** - Do exactly what was approved, no more, no less

### **üö´ NEVER:**
- ‚ùå Jump into assumptions and start building
- ‚ùå Build what you THINK user wants
- ‚ùå Add "helpful" features that weren't requested
- ‚ùå Make architectural decisions without asking
- ‚ùå Assume scope or approach

### **‚úÖ ALWAYS:**
- ‚úÖ Do EXACTLY what is asked (no more, no less)
- ‚úÖ Ask if ANYTHING is unclear or requires assumption
- ‚úÖ Get explicit approval before proceeding
- ‚úÖ Confirm we're on the same page

**IF IN DOUBT ‚Üí ASK. IF ASSUMING ‚Üí ASK. IF UNCLEAR ‚Üí ASK.**

---

## üö´ **ABSOLUTE PROHIBITIONS (UNBREAKABLE)**

### **üîí REGISTRY PROTECTION (CRITICAL - HARD BLOCK)**
**NEVER modify files marked with `"touch_again": false` in `function-registry.json`**

Protected files include (but not limited to):
- All API routes in `src/app/api/**/*` (58+ routes)
- All UI components in `src/components/ui/**/*` (30+ components)
- All finance components in `src/components/finance/**/*`
- All completed utility libraries in `src/lib/**/*`
- All completed hooks in `src/hooks/**/*`
- See `function-registry.json` for complete list (284+ protected files)

**ENFORCEMENT:** 
- Check `function-registry.json` BEFORE touching ANY file
- If `"touch_again": false` ‚Üí **STOP IMMEDIATELY** ‚Üí Report to user ‚Üí Do not proceed
- These are production-tested, working files - ANY modification will break the system

### **üìè SIZE LIMITS (HARD BLOCK)**
- **Maximum 100 lines changed per file per task**
- **Maximum 20 lines deleted per file** (prevents accidental removal)
- **No full file replacements** (threshold: >80% of lines changed)

**ENFORCEMENT:**
- Estimate change size BEFORE starting
- If >100 lines needed ‚Üí **STOP** ‚Üí Break into smaller tasks ‚Üí Ask user to approve each
- Use `search_replace` for targeted changes, never full rewrites

### **üö´ NO BYPASS FLAGS (CRITICAL - SECURITY)**
**NEVER use these git commands or flags:**
- ‚ùå `git commit --no-verify` (bypasses pre-commit hooks)
- ‚ùå `git push --force` (bypasses branch protection)
- ‚ùå `git push --no-verify` (bypasses compliance checks)
- ‚ùå Any command modifying `.git/hooks/` or compliance scripts

**If compliance check fails:**
1. **STOP immediately**
2. **Report all violations to user**
3. **Wait for explicit user decision**
4. **NEVER assume permission to bypass**

---

## ‚úÖ **MANDATORY PRE-EXECUTION CHECK**

**BEFORE ANY code modification, you MUST:**

1. **Run Pre-Check Script:**
node tools/compliance/pre-execution-check.js "<task description>"2. **Parse JSON Output:**
- Status: `PASS` = proceed, `WARN` = show warnings, `BLOCK` = **STOP**
- Existing code: Review before creating new code
- Violations: Fix violations before proceeding

3. **Act on Status:**
- **BLOCK** ‚Üí **STOP** ‚Üí Report violations ‚Üí Wait for user decision ‚Üí Do NOT proceed
- **WARN** ‚Üí Show warnings (existing code found) ‚Üí Ask user to confirm ‚Üí Wait for approval
- **PASS** ‚Üí Proceed cautiously ‚Üí Use existing code if found ‚Üí Minimal changes only

---

## üîç **MANDATORY POST-EXECUTION CHECK**

**AFTER ANY code modification, you MUST:**

1. **Run Post-Check Script:**
node tools/compliance/post-execution-check.js [modified files]2. **Parse JSON Output:**
- Status: `PASS` = no violations, `VIOLATIONS` = violations found
- Summary: Files modified, lines changed, violation counts
- Violations: List with severity (CRITICAL, HIGH, MEDIUM, LOW)

3. **Act on Violations:**
- **Report immediately** to user with:
  - List of all violations
  - Severity levels
  - Suggested fixes
  - Required actions
- **Ask user** to choose: Fix now, Continue as-is, or Revert
- **STOP** until user decides

---

## üìã **DEVELOPMENT STANDARDS (ALWAYS FOLLOW)**

### **‚öõÔ∏è REACT STANDARDS**
- ‚úÖ PascalCase file naming (e.g., `UserProfile.tsx`)
- ‚úÖ TypeScript interfaces for all props
- ‚úÖ Hooks at top level of components
- ‚úÖ Proper import order: React ‚Üí External ‚Üí Internal ‚Üí Assets
- ‚úÖ Named exports for components, default exports for pages
- ‚ùå Never use class components (functional only)

### **üé® TAILWIND CSS STANDARDS**
- ‚úÖ Use utility classes directly in JSX
- ‚úÖ Use `cva` (Class Variance Authority) for component variants
- ‚úÖ Use theme values from `tailwind.config.ts` (no arbitrary values)
- ‚ùå Never use `@apply` in global CSS
- ‚ùå Never use inline styles (use Tailwind utilities)

### **‚ö° NEXT.JS STANDARDS**
- ‚úÖ Add `'use client'` directive for client components
- ‚úÖ Use Server Components for data fetching (default)
- ‚úÖ Use Client Components for interactivity only
- ‚úÖ Use Server Actions for mutations
- ‚úÖ Proper import order and organization
- ‚úÖ Follow App Router conventions (`app/` directory)

### **üîê SUPABASE STANDARDS (CRITICAL - SECURITY)**
- ‚úÖ Use `@supabase/ssr` package exclusively
- ‚úÖ Use `getAll()` and `setAll()` cookie methods only
- ‚úÖ Always return `supabaseResponse` in middleware
- ‚úÖ Always call `auth.getUser()` in middleware
- ‚ùå **NEVER** use `@supabase/auth-helpers-nextjs` (deprecated)
- ‚ùå **NEVER** use individual cookie methods (`get/set/remove`)

### **üé® SHADCN/UI STANDARDS (CRITICAL - UI CONSISTENCY)**
- ‚úÖ **ALWAYS** use shadcn/ui components when available
- ‚úÖ Import from `@/components/ui/[component]`
- ‚úÖ Use proper shadcn component names and props
- ‚úÖ Follow shadcn component patterns and structure
- ‚ùå **NEVER** create custom implementations of shadcn components
- ‚ùå **NEVER** reinvent shadcn functionality
- ‚ùå **NEVER** use custom styling when shadcn provides the component

---

## üèóÔ∏è **INCREMENTAL CHANGES PATTERN**

### **üîß MODULAR BUILD PATTERN (100-LINE RULE)**
For every 100 lines examined, follow this hierarchy:
- **Page = Parent** (e.g., bork-api page)
- **Tab = Child** (e.g., connection-test tab)
- **Component = Grandchild** (e.g., SimpleApiTest component)
- **Sibling Tabs = Independent children**
- **Test each level** before moving to next

### **‚úÖ ALLOWED PATTERNS**
- ‚úÖ Incremental improvements (small, targeted changes)
- ‚úÖ New feature development (in new files)
- ‚úÖ Bug fixes and optimizations (minimal changes)
- ‚úÖ Following established patterns
- ‚úÖ Using existing utilities and components

### **‚ùå AVOID PATTERNS**
- ‚ùå Rebuilding existing working code
- ‚ùå Replacing entire files
- ‚ùå Deleting existing functionality without approval
- ‚ùå Making assumptions about user intent
- ‚ùå Working on multiple unrelated files simultaneously
- ‚ùå Bypassing registry checks

### **üîÑ LOOP PREVENTION (HARDCODED RULE)**
If same issue not fixed after 2 tries, on 3rd attempt:
1. **STOP** and reconsider the solution
2. **ANALYZE** what didn't work in previous attempts
3. **IDENTIFY** the root cause of failure
4. **PROPOSE** a completely different approach
5. **ASK** user for permission to try new approach
6. **MOVE ON** if no clear solution after 3 attempts
7. **LOG** the failure and what was attempted

---

## üéØ **CODE REUSE (MANDATORY)**

### **üîç SEARCH BEFORE CREATING**
**Before creating ANY new code:**
1. **Search** for existing implementations in:
   - `src/lib/` - Utility functions
   - `src/hooks/` - Custom React hooks
   - `src/components/` - Reusable components
   - `src/types/` - Type definitions
2. **Reuse** existing code whenever possible
3. **Extend** existing functionality rather than rebuild
4. **Ask** user if uncertain about existing code

### **üì¶ EXISTING UTILITIES**
This project has extensive utilities in:
- `src/lib/supabase/` - Supabase clients (server, browser, middleware)
- `src/lib/eitje/` - Eitje API integration utilities
- `src/lib/bork/` - Bork API integration utilities
- `src/lib/finance/` - Finance calculation utilities
- `src/components/ui/` - 30+ shadcn/ui components
- `src/hooks/` - Custom React hooks

**ALWAYS check these before creating new code**

---

## üö¶ **VIOLATION SEVERITIES**

### **üî¥ CRITICAL (IMMEDIATE ACTION REQUIRED)**
- Modified a protected file (`touch_again: false`)
- Used git bypass flags (`--no-verify`, `--force`)
- Modified compliance scripts or hooks
- **ACTION:** Revert changes immediately ‚Üí Report to user ‚Üí Wait for instructions

### **üü† HIGH (MUST FIX)**
- Exceeded 100-line limit per file
- Replaced entire file (>80% changed)
- Deleted a file with working functionality
- Used deprecated packages (`@supabase/auth-helpers-nextjs`)
- **ACTION:** Break down into smaller changes ‚Üí Use incremental approach ‚Üí Resubmit

### **üü° MEDIUM (REVIEW REQUIRED)**
- Deleted >20 lines from a file
- Deleted >5 import statements
- Removed >2 export statements
- Created custom implementation of shadcn component
- **ACTION:** Verify deleted code is not needed ‚Üí Review with user

### **üîµ LOW (OPTIMIZE)**
- >30 whitespace-only changes
- Non-standard import order
- **ACTION:** Use formatter ‚Üí Follow conventions

---

## üìä **WORKFLOW ENFORCEMENT**

### **üîÑ STANDARD WORKFLOW**
1. **User requests code change**
2. **AI checks `function-registry.json`** ‚Üí Verify file not protected
3. **AI runs `pre-execution-check.js`** ‚Üí Parse output ‚Üí Act on status
4. **If PASS:** Execute code modification (max 100 lines)
5. **AI runs `post-execution-check.js`** ‚Üí Parse output ‚Üí Report violations
6. **If violations:** Report to user ‚Üí Wait for decision ‚Üí Do NOT proceed
7. **If PASS:** Confirm completion ‚Üí Summarize changes

### **‚ö†Ô∏è WHEN TO STOP**
- Pre-check returns `BLOCK` status
- Protected file detected (`touch_again: false`)
- Change requires >100 lines
- Existing code found that accomplishes the task
- User has not approved proposed changes
- After 2 failed attempts at same fix

### **‚úÖ WHEN TO PROCEED**
- Pre-check returns `PASS` status
- Change is <100 lines
- File is NOT protected in registry
- User has explicitly approved
- Following all development standards

---

## üéØ **SUCCESS METRICS**

You're doing well if:
- ‚úÖ User doesn't have to repeat requests
- ‚úÖ Protected files stay untouched
- ‚úÖ Changes are minimal and targeted
- ‚úÖ No existing functionality is destroyed
- ‚úÖ User knows exactly what will change before it happens
- ‚úÖ Code follows all development standards
- ‚úÖ Modular testing pattern is followed
- ‚úÖ Pre/post-checks always run
- ‚úÖ Violations are reported immediately

---

## üîß **QUICK REFERENCE**

### **BEFORE ANY CODE CHANGE:**
# 1. Check registry
grep -A 1 "\"file\": \"path/to/file\"" function-registry.json

# 2. Run pre-check
node tools/compliance/pre-execution-check.js "your task description"

# 3. If BLOCK or WARN ‚Üí STOP ‚Üí Report to user### **AFTER ANY CODE CHANGE:**
# 1. Run post-check
node tools/compliance/post-execution-check.js path/to/modified/files

# 2. If violations ‚Üí STOP ‚Üí Report to user ‚Üí Wait for decision### **EXEMPT FILES (No size checks, but still registry-protected):**
- `function-registry.json`
- `ai-tracking-system.json`
- `progress-log.json`
- `.ai-compliance-*.json`
- `test-results.json`
- `build-log.json`

### **EXCLUDED PATHS (No compliance checks):**
- `node_modules/`
- `.git/`
- `.next/`
- `dist/`
- `build/`

---

## üí° **REMEMBER**

1. **ASK FIRST** - Always confirm before making changes
2. **CHECK REGISTRY** - Before touching ANY file
3. **RUN PRE-CHECK** - Before any code modification
4. **STAY SMALL** - Max 100 lines per file
5. **USE EXISTING** - Search before creating
6. **RUN POST-CHECK** - After any code modification
7. **REPORT VIOLATIONS** - Immediately, don't hide them
8. **WAIT FOR USER** - Never assume permission to bypass

---

**Status**: üõ°Ô∏è **UNBREAKABLE RULES ACTIVE**  
**Mode**: DEFENSIVE ONLY  
**Protected Files**: 284+ files in `function-registry.json`  
**Max Lines Per Change**: 100  
**Bypass Flags**: ‚ùå FORBIDDEN